!function(){"use strict";Backbone.Marionette.FormModel=Backbone.Model.extend({schema:{},initialize:function(){this.validation_keys=_.keys(this.validations)},validations:{email:/^[\w\-]{1,}([\w\-\+.]{1,1}[\w\-]{1,}){0,}[@][\w\-]{1,}([.]([\w\-]{1,})){1,3}$/,url:/^(http|https):\/\/(([A-Z0-9][A-Z0-9_\-]*)(\.[A-Z0-9][A-Z0-9_\-]*)+)(:(\d+))?\/?/i,number:/^\d+$/,text:function(a,b){var c=b.options&&b.options.length?b.options.length:3;return _.isString(a)&&a.length>=c},select:function(a,b){var c=b.options&&b.options.default?b.options.default:"0";return _.isString(a)&&a!==c},password:function(a,b){return _.has(b.options,"repeat")?(_.isString(b.options.repeat)&&(b.options.repeat=$(b.options.repeat)),b.options.repeat instanceof jQuery?b.options.repeat.val()===a&&this.text(a,b):this.text(a,b)):this.text(a,b)},regexp:function(a,b){if(!_.has(b.options,"regexp"))throw new Error("Regexp validation must have a regexp option to validate it");if(!_.isRegExp(b.options.regexp))throw new Error("options.regexp must be a regular expression");return b.options.regexp.test(a)},radio:function(a){return!_.isUndefined(a)},checkbox:function(a){return a},custom:function(a,b){if(!_.isFunction(b.options.regexp))throw new Error("options must be a function");return b.options(a)}},_validate:function(a,b){if(!b.validate||!this.validate)return!0;var c=this.validationError=this.validate(a,b)||null;return c?(this.trigger("invalid",this,c,_.extend(b,{validationError:c})),!1):!0},validate:function(a,b){var c,d;if(!_.isUndefined(this.schema)&&!_.isEmpty(this.schema))for(var e in a)if(c=this.schema[e]||null,d=a[e],!_.isNull(c)&&_.has(c,"type")&&_.contains(this.validation_keys,c.type)&&(c.valid=_.isFunction(this.validations[c.type])?this.validations[c.type](d,c):this.validations[c.type].test(d),!c.valid))return this.trigger("invalid:"+e,c),b.message}}),Backbone.Marionette.FormView=Backbone.Marionette.View.extend({defaultSchema:{ui:null,event:null,validate:!0,valid:!0,type:"text",message:"invalid field"},options:{model_binding:!0},schema:{},ui:{},constructor:function(a){if((_.isUndefined(a)||_.isUndefined(a.model))&&(this.model=new Backbone.Marionette.FormModel),!_.isUndefined(a)&&_.has(a,"schema")&&_.extend(this.schema,a.schema),_.isEmpty(this.schema))throw new Error("FormView instance has empty schema");return this.addSchemaElements(),Backbone.Marionette.View.apply(this,arguments),_.isUndefined(this.model)||(this.model.schema=this.schema),this},addSchemaElements:function(){for(var a in this.schema){var b=this.schema[a];_.has(b,"ui")&&!_.isEmpty(b.ui)&&(this.ui[a]=b.ui),this.schema[a]=_.extend(_.clone(this.defaultSchema),b),_.has(b,"key")||(this.schema[a].key=a)}},delegateFormEvents:function(){if(this.$el){for(var a in this.schema){var b=this.schema[a];if(_.isNull(b.ui)||_.isNull(b.event))return;this.delegateFormItem(b.event,b.ui,_.bind(this.saveItem,this),b),b.validate&&(this.ui[a].addClass("required"),this.schema[a].valid=!1,this.listenTo(this.model,"invalid:"+a,this.errorItem))}this.isValid(),this.listenTo(this.model,"invalid",this._invalid),this.options.model_binding&&this.listenTo(this.model,"change",this.fillItems)}},delegateFormItem:function(a,b,c,d){var e=d||{};this.$el.on(a+".formEvents"+this.cid,b,e,c)},undelegateFormEvents:function(){return this.$el&&this.$el.off(".formEvents"+this.cid),_.each(this.schema,_.bind(function(a,b){a.validate&&this.stopListening(this.model,"change:"+b,this.errorItem)},this)),this.stopListening(this.model,"change",this.fillItems),this.stopListening(this.model,"invalid",this._invalid),this},delegateEvents:function(a){return this._delegateDOMEvents(a),this.delegateFormEvents(),this.bindEntityEvents(this.model,this.getOption("modelEvents")),this.bindEntityEvents(this.collection,this.getOption("collectionEvents")),this},undelegateEvents:function(){var a=Array.prototype.slice.call(arguments);return Backbone.View.prototype.undelegateEvents.apply(this,a),this.undelegateFormEvents(),this.unbindEntityEvents(this.model,this.getOption("modelEvents")),this.unbindEntityEvents(this.collection,this.getOption("collectionEvents")),this},fillItems:function(a){if(!_.isEmpty(a.changed)&&this.options.model_binding)for(var b in a.changed)if(_.has(this.ui,b)){var c=this.ui[b],d=a.changed[b];switch(c.attr("type")){case"radio":var e=c.filter("[value="+d+"]");e.prop("checked")!==!0&&e.prop("checked",!0);break;case"checkbox":c.prop("checked")!==Boolean(d)&&c.prop("checked",Boolean(d));break;default:c.val()!==d&&c.val(d)}c.is("select")&&!_.isUndefined(c.select2)&&c.select2("val",d)}},saveItem:function(a){var b,c=a.data||null;if(!_.isNull(c)){switch(this.isValid(),this.ui[c.key].removeClass("invalid"),c.type){case"checkbox":b=this.ui[c.key].is(":checked");break;case"radio":b=this.ui[c.key].filter(":checked").val();break;default:b=this.ui[c.key].val()}this.model.set(c.key,b,c)}},errorItem:function(a){_.isUndefined(a)||_.isEmpty(a)||!_.has(this.ui,a.key)||(this._invalid(),this.ui[a.key].addClass("invalid"))},saveAll:function(){_.each(this.schema,_.bind(function(a,b){var c=_.extend(_.clone(this.defaultSchema),a);c.key=b,this.saveItem({data:c})},this))},isValid:function(){for(var a in this.schema)if(!this.schema[a].valid)return this._invalid(),!1;return this._valid(),!0},_invalid:function(){this.$el.removeClass("valid").addClass("invalid"),this.invalid()},_valid:function(){this.$el.removeClass("invalid").addClass("valid"),this.valid()},invalid:function(){},valid:function(){}})}(window||global||this);